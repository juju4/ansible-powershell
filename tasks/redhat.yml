---

- name: RHEL | Install Microsoft repository
  ansible.builtin.get_url:
    url: "https://packages.microsoft.com/config/rhel/{{ ansible_distribution_major_version }}/prod.repo"
    dest: /etc/yum.repos.d/microsoft.repo
    owner: root
    group: root
    mode: '0644'
  register: dl_result
  until: dl_result is success

- name: Redhat | list yum repos
  ansible.builtin.command: ls -l /etc/yum.repos.d/
  changed_when: false

- name: RedHat | Ensure /etc/rsyslog.d exists
  ansible.builtin.file:
    dest: /etc/rsyslog.d
    state: directory
    owner: root
    mode: '0755'
- name: RedHat | Ensure rsyslog use rsyslog.d directory
  ansible.builtin.lineinfile:
    dest: /etc/rsyslog.conf
    regexp: '^\$IncludeConfig /etc/.*'
    line: '$IncludeConfig /etc/rsyslog.d/*.conf'
    mode: '0644'
    backup: "{{ powershell_backup | default(false) }}"
    validate: 'rsyslogd -N2 -f %s'
  notify:
    - Restart rsyslog
